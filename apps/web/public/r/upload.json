{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "upload",
  "title": "UploadField",
  "description": "A file upload field component for BuzzForm. Supports single and multiple file uploads (hasMany), drag-and-drop, variants (dropzone, avatar, inline, gallery), progress indicators, and file previews with size validation.",
  "dependencies": [
    "@buildnbuzz/buzzform"
  ],
  "registryDependencies": [
    "@buzzform/init",
    "button",
    "progress",
    "field"
  ],
  "files": [
    {
      "path": "registry/base/fields/upload.tsx",
      "content": "\"use client\";\r\n\r\nimport React, { useRef, useState, useEffect } from \"react\";\r\nimport type {\r\n  UploadField as UploadFieldType,\r\n  FormAdapter,\r\n} from \"@buildnbuzz/buzzform\";\r\nimport { getFieldWidthStyle } from \"@buildnbuzz/buzzform\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport {\r\n  Field,\r\n  FieldContent,\r\n  FieldDescription,\r\n  FieldError,\r\n  FieldLabel,\r\n} from \"@/components/ui/field\";\r\nimport { IconPlaceholder } from \"@/components/icon-placeholder\";\r\nimport Image from \"next/image\";\r\n\r\ntype FileValue = File | string | null;\r\ntype FileArrayValue = (File | string)[];\r\n\r\nfunction isImage(file: File | string): boolean {\r\n  if (typeof file === \"string\") {\r\n    return /\\.(jpeg|jpg|gif|png|webp|svg|bmp|ico)$/i.test(file);\r\n  }\r\n  return file.type.startsWith(\"image/\");\r\n}\r\n\r\nfunction getPreviewUrl(file: File | string): string | null {\r\n  if (typeof file === \"string\") return file;\r\n  if (file.type.startsWith(\"image/\")) return URL.createObjectURL(file);\r\n  return null;\r\n}\r\n\r\nfunction formatFileSize(bytes: number): string {\r\n  if (bytes < 1024) return `${bytes} B`;\r\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\r\n  return `${(bytes / 1024 / 1024).toFixed(2)} MB`;\r\n}\r\n\r\nfunction getFileName(file: File | string): string {\r\n  if (typeof file === \"string\") {\r\n    const parts = file.split(\"/\");\r\n    return parts[parts.length - 1] || \"file\";\r\n  }\r\n  return file.name;\r\n}\r\n\r\ntype SizeKey = \"xs\" | \"sm\" | \"md\" | \"lg\" | \"xl\";\r\n\r\nconst SIZE_MAP: Record<\r\n  SizeKey,\r\n  { width: number; height: number; className: string }\r\n> = {\r\n  xs: { width: 64, height: 64, className: \"size-16\" },\r\n  sm: { width: 80, height: 80, className: \"size-20\" },\r\n  md: { width: 96, height: 96, className: \"size-24\" },\r\n  lg: { width: 128, height: 128, className: \"size-32\" },\r\n  xl: { width: 160, height: 160, className: \"size-40\" },\r\n};\r\n\r\nconst DZ_SIZE_MAP: Record<\r\n  SizeKey,\r\n  { minHeight: string; padding: string; iconSize: string }\r\n> = {\r\n  xs: { minHeight: \"min-h-24\", padding: \"py-4\", iconSize: \"size-4\" },\r\n  sm: { minHeight: \"min-h-32\", padding: \"py-6\", iconSize: \"size-5\" },\r\n  md: { minHeight: \"min-h-40\", padding: \"py-8\", iconSize: \"size-6\" },\r\n  lg: { minHeight: \"min-h-56\", padding: \"py-12\", iconSize: \"size-8\" },\r\n  xl: { minHeight: \"min-h-72\", padding: \"py-16\", iconSize: \"size-10\" },\r\n};\r\n\r\nfunction CircularProgress({\r\n  progress,\r\n  size = 40,\r\n}: {\r\n  progress: number;\r\n  size?: number;\r\n}) {\r\n  const radius = size * 0.4;\r\n  const circum = 2 * Math.PI * radius;\r\n  const offset = circum - (progress / 100) * circum;\r\n\r\n  return (\r\n    <div className=\"relative inline-flex items-center justify-center\">\r\n      <svg width={size} height={size} className=\"-rotate-90\">\r\n        <circle\r\n          cx={size / 2}\r\n          cy={size / 2}\r\n          r={radius}\r\n          stroke=\"currentColor\"\r\n          strokeWidth=\"3\"\r\n          fill=\"transparent\"\r\n          className=\"text-muted/20\"\r\n        />\r\n        <circle\r\n          cx={size / 2}\r\n          cy={size / 2}\r\n          r={radius}\r\n          stroke=\"currentColor\"\r\n          strokeWidth=\"3\"\r\n          fill=\"transparent\"\r\n          strokeDasharray={circum}\r\n          strokeDashoffset={offset}\r\n          strokeLinecap=\"round\"\r\n          className=\"text-primary transition-all duration-300 ease-out\"\r\n        />\r\n      </svg>\r\n      <span className=\"absolute text-[10px] font-bold\">\r\n        {Math.round(progress)}%\r\n      </span>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction DropzoneVariant({\r\n  field,\r\n  value,\r\n  progress,\r\n  onChange,\r\n  disabled,\r\n  inputRef,\r\n}: {\r\n  field: UploadFieldType;\r\n  value: FileValue;\r\n  progress?: number;\r\n  onChange: (value: FileValue) => void;\r\n  disabled?: boolean;\r\n  inputRef: React.RefObject<HTMLInputElement | null>;\r\n}) {\r\n  const [isDragging, setIsDragging] = useState(false);\r\n  const previewUrl = value ? getPreviewUrl(value) : null;\r\n\r\n  useEffect(() => {\r\n    const url = previewUrl;\r\n    return () => {\r\n      if (\r\n        typeof url === \"string\" &&\r\n        url.startsWith(\"blob:\") &&\r\n        value instanceof File\r\n      ) {\r\n        URL.revokeObjectURL(url);\r\n      }\r\n    };\r\n  }, [previewUrl, value]);\r\n\r\n  const handleDragOver = (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    setIsDragging(true);\r\n  };\r\n\r\n  const handleDragLeave = () => setIsDragging(false);\r\n\r\n  const handleDrop = (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    setIsDragging(false);\r\n    if (disabled) return;\r\n    const file = e.dataTransfer.files?.[0];\r\n    if (file) onChange(file);\r\n  };\r\n\r\n  const handleRemove = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    onChange(null);\r\n  };\r\n\r\n  const sizeConfig = (field.ui?.size as SizeKey) || \"md\";\r\n  const dzSize = DZ_SIZE_MAP[sizeConfig] || DZ_SIZE_MAP.md;\r\n  const isImageValue = value ? isImage(value) : false;\r\n  const shape = field.ui?.shape || \"rounded\";\r\n  const shapeClass =\r\n    shape === \"circle\"\r\n      ? \"rounded-full\"\r\n      : shape === \"rounded\"\r\n        ? \"rounded-xl\"\r\n        : \"rounded-lg\";\r\n\r\n  return (\r\n    <div\r\n      onClick={() => !disabled && inputRef.current?.click()}\r\n      onDragOver={!disabled ? handleDragOver : undefined}\r\n      onDragLeave={!disabled ? handleDragLeave : undefined}\r\n      onDrop={!disabled ? handleDrop : undefined}\r\n      className={cn(\r\n        \"relative group flex flex-col items-center justify-center w-full border-2 border-dashed transition-all cursor-pointer text-center\",\r\n        shapeClass,\r\n        isDragging\r\n          ? \"border-primary bg-primary/5 scale-[1.01]\"\r\n          : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/25\",\r\n        !value ? `${dzSize.minHeight} ${dzSize.padding}` : \"min-h-0 py-4\",\r\n        disabled && \"opacity-50 cursor-not-allowed pointer-events-none\"\r\n      )}\r\n    >\r\n      {value && !disabled && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleRemove}\r\n          className=\"absolute -top-2 -right-2 p-1 rounded-full bg-background border shadow-md hover:bg-muted text-muted-foreground transition-all z-50 opacity-0 group-hover:opacity-100\"\r\n        >\r\n          <IconPlaceholder\r\n            lucide=\"X\"\r\n            tabler=\"IconX\"\r\n            hugeicons=\"Cancel01Icon\"\r\n            phosphor=\"X\"\r\n            className=\"size-3\"\r\n          />\r\n        </button>\r\n      )}\r\n\r\n      <div className=\"w-full h-full flex flex-col items-center justify-center p-6 gap-3\">\r\n        {value ? (\r\n          <div className=\"relative w-full flex flex-col items-center justify-center gap-4 px-4\">\r\n            {previewUrl && isImageValue ? (\r\n              <div className=\"relative group/preview w-full flex flex-col items-center gap-4\">\r\n                <div className=\"relative h-32 w-full max-w-60 shadow-sm ring-1 ring-border rounded-md overflow-hidden\">\r\n                  <Image\r\n                    src={previewUrl}\r\n                    alt=\"Preview\"\r\n                    fill\r\n                    className=\"object-cover\"\r\n                    unoptimized\r\n                  />\r\n                  {progress !== undefined && progress < 100 && (\r\n                    <div className=\"absolute inset-0 bg-background/60 backdrop-blur-[2px] flex items-center justify-center\">\r\n                      <CircularProgress progress={progress} size={44} />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                <div className=\"flex flex-col items-center gap-1\">\r\n                  <p className=\"text-sm font-medium text-foreground truncate max-w-50\">\r\n                    {getFileName(value)}\r\n                  </p>\r\n                  {value instanceof File && (\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {formatFileSize(value.size)}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <div className=\"flex items-center gap-4 text-muted-foreground w-full max-w-md mx-auto p-3 rounded-lg border bg-muted/30\">\r\n                <div className=\"relative shrink-0\">\r\n                  <div className=\"p-2 rounded-md bg-background border shadow-sm\">\r\n                    <IconPlaceholder\r\n                      lucide=\"File\"\r\n                      tabler=\"IconFile\"\r\n                      hugeicons=\"File02Icon\"\r\n                      phosphor=\"File\"\r\n                      className=\"size-8 text-primary\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n                <div className=\"text-left flex-1 min-w-0 flex flex-col gap-0.5\">\r\n                  <p className=\"text-sm font-medium text-foreground truncate\">\r\n                    {getFileName(value)}\r\n                  </p>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    {value instanceof File && (\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {formatFileSize(value.size)}\r\n                      </p>\r\n                    )}\r\n                    {progress !== undefined && progress < 100 && (\r\n                      <span className=\"text-[10px] font-medium text-primary bg-primary/10 px-1.5 py-0.5 rounded\">\r\n                        {Math.round(progress)}%\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                  {progress !== undefined && progress < 100 && (\r\n                    <div className=\"mt-2 w-full\">\r\n                      <Progress value={progress} />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <>\r\n            <div\r\n              className={cn(\r\n                \"rounded-full bg-muted/50\",\r\n                dzSize.iconSize === \"size-4\" ? \"p-2\" : \"p-3\"\r\n              )}\r\n            >\r\n              <IconPlaceholder\r\n                lucide=\"Upload\"\r\n                tabler=\"IconUpload\"\r\n                hugeicons=\"Upload04Icon\"\r\n                phosphor=\"UploadSimple\"\r\n                className={cn(dzSize.iconSize, \"text-muted-foreground\")}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-1\">\r\n              <p\r\n                className={cn(\r\n                  \"font-medium\",\r\n                  sizeConfig === \"xs\" ? \"text-[10px]\" : \"text-sm\"\r\n                )}\r\n              >\r\n                <span className=\"text-primary font-semibold\">\r\n                  {field.ui?.dropzoneText || \"Click to upload\"}\r\n                </span>{\" \"}\r\n                {sizeConfig !== \"xs\" &&\r\n                  sizeConfig !== \"sm\" &&\r\n                  \"or drag and drop\"}\r\n              </p>\r\n              {sizeConfig !== \"xs\" && sizeConfig !== \"sm\" && (\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {field.ui?.accept\r\n                    ? field.ui.accept.split(\",\").join(\", \")\r\n                    : \"Any file\"}\r\n                  {field.maxSize && ` (Max ${formatFileSize(field.maxSize)})`}\r\n                </p>\r\n              )}\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction AvatarVariant({\r\n  field,\r\n  value,\r\n  progress,\r\n  onChange,\r\n  disabled,\r\n  inputRef,\r\n}: {\r\n  field: UploadFieldType;\r\n  value: FileValue;\r\n  progress?: number;\r\n  onChange: (value: FileValue) => void;\r\n  disabled?: boolean;\r\n  inputRef: React.RefObject<HTMLInputElement | null>;\r\n}) {\r\n  const [isHovering, setIsHovering] = useState(false);\r\n\r\n  const shape = field.ui?.shape || \"circle\";\r\n  const sizeConfig = field.ui?.size || \"md\";\r\n  const sizeClass =\r\n    typeof sizeConfig === \"string\" && sizeConfig in SIZE_MAP\r\n      ? SIZE_MAP[sizeConfig as SizeKey].className\r\n      : \"size-24\";\r\n\r\n  const shapeClass =\r\n    shape === \"circle\"\r\n      ? \"rounded-full\"\r\n      : shape === \"rounded\"\r\n        ? \"rounded-xl\"\r\n        : \"rounded-md\";\r\n\r\n  const previewUrl = value ? getPreviewUrl(value) : null;\r\n\r\n  useEffect(() => {\r\n    const url = previewUrl;\r\n    return () => {\r\n      if (url && value instanceof File) URL.revokeObjectURL(url);\r\n    };\r\n  }, [previewUrl, value]);\r\n\r\n  const handleRemove = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    onChange(null);\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"relative inline-flex items-center justify-center\",\r\n        sizeClass\r\n      )}\r\n      onMouseEnter={() => setIsHovering(true)}\r\n      onMouseLeave={() => setIsHovering(false)}\r\n    >\r\n      <div\r\n        className={cn(\r\n          \"w-full h-full border-2 border-dashed transition-all cursor-pointer overflow-hidden flex flex-col items-center justify-center\",\r\n          shapeClass,\r\n          disabled\r\n            ? \"opacity-50 cursor-not-allowed\"\r\n            : \"hover:border-primary/50 hover:bg-muted/50\",\r\n          value ? \"border-transparent\" : \"border-muted-foreground/25\"\r\n        )}\r\n        onClick={() => !disabled && inputRef.current?.click()}\r\n      >\r\n        {previewUrl ? (\r\n          <div className=\"relative w-full h-full\">\r\n            <Image\r\n              src={previewUrl}\r\n              alt=\"Avatar\"\r\n              fill\r\n              className={cn(\"object-cover\", shapeClass)}\r\n              unoptimized\r\n            />\r\n            {progress !== undefined && progress < 100 && (\r\n              <div className=\"absolute inset-0 bg-background/60 backdrop-blur-[1px] flex items-center justify-center\">\r\n                <CircularProgress\r\n                  progress={progress}\r\n                  size={sizeConfig === \"xs\" ? 32 : 40}\r\n                />\r\n              </div>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <div className=\"flex flex-col items-center justify-center gap-1 text-muted-foreground\">\r\n            <IconPlaceholder\r\n              lucide=\"Image\"\r\n              tabler=\"IconPhoto\"\r\n              hugeicons=\"Image01Icon\"\r\n              phosphor=\"Image\"\r\n              className=\"size-6\"\r\n            />\r\n            <span className=\"text-[10px]\">Upload</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n      {previewUrl && !disabled && isHovering && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleRemove}\r\n          className=\"absolute top-0 right-0 translate-x-1/2 -translate-y-1/2 p-1 rounded-full bg-background border shadow-sm hover:bg-muted text-muted-foreground transition-all z-50\"\r\n        >\r\n          <IconPlaceholder\r\n            lucide=\"X\"\r\n            tabler=\"IconX\"\r\n            hugeicons=\"Cancel01Icon\"\r\n            phosphor=\"X\"\r\n            className=\"size-3\"\r\n          />\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction InlineVariant({\r\n  field,\r\n  value,\r\n  onChange,\r\n  disabled,\r\n  inputRef,\r\n}: {\r\n  field: UploadFieldType;\r\n  value: FileValue;\r\n  onChange: (value: FileValue) => void;\r\n  disabled?: boolean;\r\n  inputRef: React.RefObject<HTMLInputElement | null>;\r\n}) {\r\n  const sizeConfig = (field.ui?.size as SizeKey) || \"md\";\r\n  const btnSize =\r\n    sizeConfig === \"xs\" || sizeConfig === \"sm\"\r\n      ? sizeConfig\r\n      : sizeConfig === \"xl\"\r\n        ? \"lg\"\r\n        : \"default\";\r\n  const iconSize = sizeConfig === \"xs\" ? \"size-3.5\" : \"size-4\";\r\n  return (\r\n    <div className=\"flex items-center gap-3\">\r\n      <Button\r\n        type=\"button\"\r\n        variant=\"outline\"\r\n        size={btnSize}\r\n        onClick={() => !disabled && inputRef.current?.click()}\r\n        disabled={disabled}\r\n        className=\"gap-2\"\r\n      >\r\n        <IconPlaceholder\r\n          lucide=\"Upload\"\r\n          tabler=\"IconUpload\"\r\n          hugeicons=\"Upload04Icon\"\r\n          phosphor=\"UploadSimple\"\r\n          className={iconSize}\r\n        />\r\n        {sizeConfig === \"xs\" ? \"Upload\" : \"Choose File\"}\r\n      </Button>\r\n      {value ? (\r\n        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n          <span className=\"truncate max-w-48\">{getFileName(value)}</span>\r\n          {!disabled && (\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => onChange(null)}\r\n              className=\"flex items-center justify-center p-1 rounded-full hover:bg-muted text-muted-foreground transition-colors\"\r\n            >\r\n              <IconPlaceholder\r\n                lucide=\"X\"\r\n                tabler=\"IconX\"\r\n                hugeicons=\"Cancel01Icon\"\r\n                phosphor=\"X\"\r\n                className=\"size-4\"\r\n              />\r\n            </button>\r\n          )}\r\n        </div>\r\n      ) : (\r\n        <span className=\"text-sm text-muted-foreground\">No file selected</span>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction GalleryThumbnail({\r\n  file,\r\n  size,\r\n  shape,\r\n  progress,\r\n  onRemove,\r\n  disabled,\r\n}: {\r\n  file: File | string;\r\n  size: number;\r\n  shape: \"circle\" | \"square\" | \"rounded\";\r\n  progress?: number;\r\n  onRemove: () => void;\r\n  disabled?: boolean;\r\n}) {\r\n  const shapeClass =\r\n    shape === \"circle\"\r\n      ? \"rounded-full\"\r\n      : shape === \"rounded\"\r\n        ? \"rounded-lg\"\r\n        : \"rounded-md\";\r\n\r\n  const previewUrl = getPreviewUrl(file);\r\n\r\n  useEffect(() => {\r\n    const url = previewUrl;\r\n    return () => {\r\n      // Only revoke if it's a blob URL we created\r\n      if (\r\n        typeof url === \"string\" &&\r\n        url.startsWith(\"blob:\") &&\r\n        file instanceof File\r\n      ) {\r\n        URL.revokeObjectURL(url);\r\n      }\r\n    };\r\n  }, [previewUrl, file]);\r\n\r\n  const isImageFile = isImage(file);\r\n\r\n  return (\r\n    <div style={{ width: size, height: size }} className=\"relative group\">\r\n      <div\r\n        className={cn(\r\n          \"w-full h-full overflow-hidden border border-border bg-muted/50 transition-colors\",\r\n          shapeClass\r\n        )}\r\n      >\r\n        {previewUrl && isImageFile ? (\r\n          <div className=\"relative w-full h-full\">\r\n            <Image\r\n              src={previewUrl}\r\n              alt=\"\"\r\n              fill\r\n              className=\"object-cover\"\r\n              unoptimized\r\n            />\r\n            {progress !== undefined && progress < 100 && (\r\n              <div className=\"absolute inset-x-1.5 bottom-1.5\">\r\n                <Progress value={progress} />\r\n              </div>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <div className=\"w-full h-full flex flex-col items-center justify-center p-2\">\r\n            <IconPlaceholder\r\n              lucide=\"File\"\r\n              tabler=\"IconFile\"\r\n              hugeicons=\"File02Icon\"\r\n              phosphor=\"File\"\r\n              className=\"size-6 text-muted-foreground\"\r\n            />\r\n            <span className=\"text-[10px] text-muted-foreground mt-1 truncate max-w-full px-1\">\r\n              {getFileName(file)}\r\n            </span>\r\n            {progress !== undefined && progress < 100 && (\r\n              <Progress value={progress} className=\"mt-2 w-[80%]\" />\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n      {!disabled && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={onRemove}\r\n          className={cn(\r\n            \"absolute top-0 right-0 translate-x-1/2 -translate-y-1/2 p-1 rounded-full bg-background border shadow-sm text-muted-foreground transition-all z-50\",\r\n            \"opacity-0 group-hover:opacity-100\",\r\n            \"hover:bg-muted\"\r\n          )}\r\n        >\r\n          <IconPlaceholder\r\n            lucide=\"X\"\r\n            tabler=\"IconX\"\r\n            hugeicons=\"Cancel01Icon\"\r\n            phosphor=\"X\"\r\n            className=\"size-3\"\r\n          />\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction GalleryVariant({\r\n  field,\r\n  value = [],\r\n  progressMap,\r\n  onChange,\r\n  disabled,\r\n  inputRef,\r\n}: {\r\n  field: UploadFieldType;\r\n  value: FileArrayValue;\r\n  progressMap: Record<string, number>;\r\n  onChange: (value: FileArrayValue) => void;\r\n  disabled?: boolean;\r\n  inputRef: React.RefObject<HTMLInputElement | null>;\r\n}) {\r\n  const sizeConfig = field.ui?.size || \"md\";\r\n  const thumbnailSize =\r\n    typeof sizeConfig === \"string\" && sizeConfig in SIZE_MAP\r\n      ? SIZE_MAP[sizeConfig as SizeKey].width\r\n      : 100;\r\n\r\n  const shape = field.ui?.shape || \"rounded\";\r\n  const maxFiles = field.maxFiles;\r\n  const minFiles = field.minFiles;\r\n\r\n  const handleRemove = (index: number) => {\r\n    const newFiles = [...value];\r\n    newFiles.splice(index, 1);\r\n    onChange(newFiles);\r\n  };\r\n\r\n  const fileIds = (() => {\r\n    const seen = new Map<string, number>();\r\n    return value.map((file) => {\r\n      const baseId =\r\n        file instanceof File\r\n          ? `${file.name}-${file.size}-${file.lastModified}`\r\n          : file;\r\n      const count = (seen.get(baseId) || 0) + 1;\r\n      seen.set(baseId, count);\r\n      return count === 1 ? baseId : `${baseId}-${count}`;\r\n    });\r\n  })();\r\n\r\n  const canAddMore = !maxFiles || value.length < maxFiles;\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <div className=\"flex flex-wrap gap-3\">\r\n        {value.map((file, index) => {\r\n          const fileId = fileIds[index];\r\n          return (\r\n            <GalleryThumbnail\r\n              key={fileId}\r\n              file={file}\r\n              size={thumbnailSize}\r\n              shape={field.ui?.shape || \"rounded\"}\r\n              progress={progressMap[fileId]}\r\n              onRemove={() => handleRemove(index)}\r\n              disabled={disabled}\r\n            />\r\n          );\r\n        })}\r\n        {canAddMore && !disabled && (\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => inputRef.current?.click()}\r\n            className={cn(\r\n              \"flex flex-col items-center justify-center border-2 border-dashed transition-colors gap-2\",\r\n              \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\",\r\n              \"text-muted-foreground hover:text-foreground\",\r\n              shape === \"circle\"\r\n                ? \"rounded-full\"\r\n                : shape === \"rounded\"\r\n                  ? \"rounded-xl\"\r\n                  : \"rounded-md\"\r\n            )}\r\n            style={{ width: thumbnailSize, height: thumbnailSize }}\r\n          >\r\n            <IconPlaceholder\r\n              lucide=\"Plus\"\r\n              tabler=\"IconPlus\"\r\n              hugeicons=\"Add01Icon\"\r\n              phosphor=\"Plus\"\r\n              className={cn(thumbnailSize < 80 ? \"size-4\" : \"size-6\")}\r\n            />\r\n            {thumbnailSize >= 100 && (\r\n              <span className=\"text-[10px] font-medium px-2 text-center leading-none\">\r\n                {field.ui?.dropzoneText || \"Add\"}\r\n              </span>\r\n            )}\r\n          </button>\r\n        )}\r\n      </div>\r\n      {(maxFiles || minFiles) && (\r\n        <div className=\"flex items-center gap-2 text-xs text-muted-foreground mt-1\">\r\n          <p>\r\n            {value.length} {maxFiles ? `/ ${maxFiles}` : \"\"} files\r\n          </p>\r\n          {minFiles && value.length < minFiles && (\r\n            <p className=\"text-destructive font-medium\">\r\n              (Min {minFiles} required)\r\n            </p>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport interface UploadFieldProps {\r\n  field: UploadFieldType;\r\n  path: string;\r\n  form: FormAdapter;\r\n  autoFocus?: boolean;\r\n  formValues: Record<string, unknown>;\r\n  siblingData: Record<string, unknown>;\r\n  // Computed props\r\n  fieldId: string;\r\n  label: React.ReactNode | null;\r\n  isDisabled: boolean;\r\n  isReadOnly: boolean;\r\n  error?: string;\r\n}\r\n\r\nexport function UploadField({\r\n  field,\r\n  path,\r\n  form,\r\n  autoFocus,\r\n  fieldId,\r\n  label,\r\n  isDisabled,\r\n  isReadOnly,\r\n  error,\r\n}: UploadFieldProps) {\r\n  const inputRef = useRef<HTMLInputElement | null>(null);\r\n  const value = form.watch(path);\r\n  const [progressMap, setProgressMap] = useState<Record<string, number>>({});\r\n  const hasError = !!error;\r\n\r\n  const variant = field.ui?.variant || \"dropzone\";\r\n  const hasMany = field.hasMany;\r\n  const showProgress = field.ui?.showProgress;\r\n\r\n  const simulateProgress = (fileId: string) => {\r\n    // Check if already 100 or already simulating\r\n    if (progressMap[fileId] === 100) return;\r\n\r\n    let current = 0;\r\n    const interval = setInterval(() => {\r\n      current += Math.random() * 15 + 2;\r\n      if (current >= 100) {\r\n        current = 100;\r\n        clearInterval(interval);\r\n      }\r\n      setProgressMap((prev) => ({ ...prev, [fileId]: current }));\r\n    }, 300);\r\n  };\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = e.target.files;\r\n    if (!files?.length) return;\r\n\r\n    if (hasMany) {\r\n      const currentValue = (value as FileArrayValue) || [];\r\n      const newFiles = Array.from(files);\r\n      const combined = [...currentValue, ...newFiles];\r\n\r\n      if (showProgress) {\r\n        newFiles.forEach((f, idx) => {\r\n          // Include index and timestamp for absolute uniqueness within a single select\r\n          const id = `${f.name}-${f.size}-${f.lastModified}-${Date.now()}-${idx}`;\r\n          simulateProgress(id);\r\n        });\r\n      }\r\n\r\n      const maxFiles = field.maxFiles;\r\n      const finalValue = maxFiles ? combined.slice(0, maxFiles) : combined;\r\n\r\n      form.setValue(path, finalValue, {\r\n        shouldDirty: true,\r\n        shouldValidate: true,\r\n      });\r\n    } else {\r\n      const file = files[0];\r\n\r\n      if (showProgress && file) {\r\n        const id = `${file.name}-${file.size}-${file.lastModified}-${Date.now()}`;\r\n        simulateProgress(id);\r\n      }\r\n\r\n      form.setValue(path, file, {\r\n        shouldDirty: true,\r\n        shouldValidate: true,\r\n      });\r\n    }\r\n\r\n    if (inputRef.current) inputRef.current.value = \"\";\r\n  };\r\n\r\n  const handleSingleChange = (newValue: FileValue) => {\r\n    form.setValue(path, newValue, {\r\n      shouldDirty: true,\r\n      shouldValidate: true,\r\n    });\r\n  };\r\n\r\n  const handleMultiChange = (newValue: FileArrayValue) => {\r\n    form.setValue(path, newValue, {\r\n      shouldDirty: true,\r\n      shouldValidate: true,\r\n    });\r\n  };\r\n\r\n  const renderVariant = () => {\r\n    const commonProps = {\r\n      field,\r\n      disabled: isDisabled || isReadOnly,\r\n      inputRef,\r\n    };\r\n\r\n    if (process.env.NODE_ENV === \"development\" && field.ui?.crop) {\r\n      console.warn(\r\n        `UploadField (${field.name}): 'crop' option is currently not implemented.`\r\n      );\r\n    }\r\n\r\n    if (hasMany) {\r\n      return (\r\n        <GalleryVariant\r\n          {...commonProps}\r\n          value={(value as FileArrayValue) || []}\r\n          progressMap={progressMap}\r\n          onChange={handleMultiChange}\r\n        />\r\n      );\r\n    }\r\n\r\n    const fileId =\r\n      value instanceof File\r\n        ? `${value.name}-${value.size}-${value.lastModified}`\r\n        : null;\r\n    const currentProgress = fileId ? progressMap[fileId] : undefined;\r\n\r\n    switch (variant) {\r\n      case \"avatar\":\r\n        return (\r\n          <AvatarVariant\r\n            {...commonProps}\r\n            value={value as FileValue}\r\n            progress={currentProgress}\r\n            onChange={handleSingleChange}\r\n          />\r\n        );\r\n      case \"inline\":\r\n        return (\r\n          <InlineVariant\r\n            {...commonProps}\r\n            value={value as FileValue}\r\n            onChange={handleSingleChange}\r\n          />\r\n        );\r\n      case \"dropzone\":\r\n      case \"gallery\":\r\n      default:\r\n        return (\r\n          <DropzoneVariant\r\n            {...commonProps}\r\n            value={value as FileValue}\r\n            progress={currentProgress}\r\n            onChange={handleSingleChange}\r\n          />\r\n        );\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Field\r\n      className={field.style?.className}\r\n      data-invalid={hasError}\r\n      data-disabled={isDisabled}\r\n      style={getFieldWidthStyle(field.style)}\r\n    >\r\n      {label && (\r\n        <FieldLabel htmlFor={fieldId} className=\"gap-1 items-baseline\">\r\n          {label}\r\n          {field.required && <span className=\"text-destructive\">*</span>}\r\n        </FieldLabel>\r\n      )}\r\n\r\n      <FieldContent>\r\n        <input\r\n          id={fieldId}\r\n          type=\"file\"\r\n          ref={inputRef}\r\n          className=\"hidden\"\r\n          accept={field.ui?.accept}\r\n          multiple={hasMany}\r\n          onChange={handleFileChange}\r\n          disabled={isDisabled || isReadOnly}\r\n          autoFocus={autoFocus}\r\n        />\r\n        {renderVariant()}\r\n      </FieldContent>\r\n\r\n      {field.description && (\r\n        <FieldDescription id={`${fieldId}-description`}>\r\n          {field.description}\r\n        </FieldDescription>\r\n      )}\r\n\r\n      {error && <FieldError>{error}</FieldError>}\r\n    </Field>\r\n  );\r\n}\r\n\r\nexport function UploadFieldSkeleton({ field }: { field: UploadFieldType }) {\r\n  const label = field.label !== false ? (field.label ?? field.name) : null;\r\n  const variant = field.ui?.variant || \"dropzone\";\r\n  const sizeConfig = field.ui?.size || \"md\";\r\n  const shape = field.ui?.shape || \"circle\";\r\n\r\n  const shapeClass =\r\n    shape === \"circle\"\r\n      ? \"rounded-full\"\r\n      : shape === \"rounded\"\r\n        ? \"rounded-xl\"\r\n        : \"rounded-md\";\r\n\r\n  const sizeClass =\r\n    typeof sizeConfig === \"string\" && sizeConfig in SIZE_MAP\r\n      ? SIZE_MAP[sizeConfig as SizeKey].className\r\n      : \"size-24\";\r\n\r\n  if (variant === \"avatar\") {\r\n    return (\r\n      <Field className={field.style?.className}>\r\n        {label && <div className=\"h-4 w-20 animate-pulse rounded bg-muted\" />}\r\n        <FieldContent>\r\n          <div\r\n            className={cn(\"animate-pulse bg-muted\", sizeClass, shapeClass)}\r\n          />\r\n        </FieldContent>\r\n        {field.description && (\r\n          <div className=\"h-3 w-32 mt-2 animate-pulse rounded bg-muted\" />\r\n        )}\r\n      </Field>\r\n    );\r\n  }\r\n\r\n  if (variant === \"inline\") {\r\n    return (\r\n      <Field className={field.style?.className}>\r\n        {label && <div className=\"h-4 w-20 animate-pulse rounded bg-muted\" />}\r\n        <FieldContent>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"h-9 w-28 animate-pulse rounded-md bg-muted\" />\r\n            <div className=\"h-4 w-24 animate-pulse rounded bg-muted\" />\r\n          </div>\r\n        </FieldContent>\r\n      </Field>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Field className={field.style?.className}>\r\n      {label && <div className=\"h-4 w-24 animate-pulse rounded bg-muted\" />}\r\n      <FieldContent>\r\n        <div className=\"h-40 w-full animate-pulse rounded-lg bg-muted\" />\r\n      </FieldContent>\r\n      {field.description && (\r\n        <div className=\"h-3 w-48 mt-2 animate-pulse rounded bg-muted\" />\r\n      )}\r\n    </Field>\r\n  );\r\n}\r\n",
      "type": "registry:component",
      "target": "components/buzzform/fields/upload.tsx"
    }
  ],
  "type": "registry:ui"
}