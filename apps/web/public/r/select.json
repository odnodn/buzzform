{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "select",
  "title": "SelectField",
  "description": "A select dropdown field component for BuzzForm. Supports single and multi-select (hasMany), static or async options, dependent dropdowns (dependencies), searchable, clearable, and custom option rendering with icons and descriptions.",
  "dependencies": [
    "@buildnbuzz/buzzform"
  ],
  "registryDependencies": [
    "@buzzform/init",
    "combobox",
    "input-group",
    "field"
  ],
  "files": [
    {
      "path": "registry/base/fields/select.tsx",
      "content": "\"use client\";\r\n\r\nimport {\r\n  useState,\r\n  useEffect,\r\n  useMemo,\r\n  useCallback,\r\n  useRef,\r\n  type ReactNode,\r\n} from \"react\";\r\nimport type {\r\n  SelectField as SelectFieldType,\r\n  SelectOption,\r\n  FormAdapter,\r\n  ValidationContext,\r\n} from \"@buildnbuzz/buzzform\";\r\n\r\ninterface ExtendedSelectOption extends SelectOption {\r\n  badge?: string;\r\n}\r\n\r\nimport { generateFieldId, getNestedValue } from \"@buildnbuzz/buzzform\";\r\nimport {\r\n  Field,\r\n  FieldContent,\r\n  FieldDescription,\r\n  FieldError,\r\n  FieldLabel,\r\n} from \"@/components/ui/field\";\r\nimport {\r\n  Combobox,\r\n  ComboboxInput,\r\n  ComboboxContent,\r\n  ComboboxList,\r\n  ComboboxItem,\r\n  ComboboxEmpty,\r\n  ComboboxChips,\r\n  ComboboxChip,\r\n  ComboboxChipsInput,\r\n  ComboboxTrigger,\r\n  ComboboxValue,\r\n  ComboboxClear,\r\n  useComboboxAnchor,\r\n} from \"@/components/ui/combobox\";\r\nimport {\r\n  InputGroup,\r\n  InputGroupAddon,\r\n  InputGroupButton,\r\n} from \"@/components/ui/input-group\";\r\n\r\nexport interface SelectFieldProps {\r\n  field: SelectFieldType;\r\n  path: string;\r\n  form: FormAdapter;\r\n  autoFocus?: boolean;\r\n  formValues: Record<string, unknown>;\r\n  siblingData: Record<string, unknown>;\r\n}\r\n\r\ntype OptionValue = string | number | boolean;\r\n\r\nfunction getOptionLabel(option: SelectOption | string): string {\r\n  if (typeof option === \"string\") return option;\r\n  return typeof option.label === \"string\" ? option.label : String(option.value);\r\n}\r\n\r\nfunction getOptionLabelNode(option: SelectOption | string): ReactNode {\r\n  if (typeof option === \"string\") return option;\r\n  return option.label;\r\n}\r\n\r\nfunction normalizeOption(option: SelectOption | string): SelectOption {\r\n  if (typeof option === \"string\") {\r\n    return { value: option, label: option };\r\n  }\r\n  return option;\r\n}\r\n\r\nfunction valueToString(value: OptionValue): string {\r\n  if (typeof value === \"boolean\") return value ? \"true\" : \"false\";\r\n  return String(value);\r\n}\r\n\r\nfunction stringToValue(\r\n  str: string,\r\n  options: SelectOption[]\r\n): OptionValue | undefined {\r\n  const option = options.find((opt) => valueToString(opt.value) === str);\r\n  return option?.value;\r\n}\r\n\r\nfunction isAsyncOptions(\r\n  options: SelectFieldType[\"options\"]\r\n): options is (context: ValidationContext) => Promise<SelectOption[]> {\r\n  return typeof options === \"function\";\r\n}\r\n\r\nfunction useAsyncOptions(\r\n  options: SelectFieldType[\"options\"],\r\n  dependencies: string[] | undefined,\r\n  formValues: Record<string, unknown>,\r\n  siblingData: Record<string, unknown>,\r\n  path: string\r\n): {\r\n  resolvedOptions: SelectOption[];\r\n  isLoading: boolean;\r\n} {\r\n  const isAsync = isAsyncOptions(options);\r\n  const cacheRef = useRef<Map<string, SelectOption[]>>(new Map());\r\n\r\n  const [resolvedOptions, setResolvedOptions] = useState<SelectOption[]>(\r\n    !isAsync ? (Array.isArray(options) ? options.map(normalizeOption) : []) : []\r\n  );\r\n  const [isLoading, setIsLoading] = useState(isAsync);\r\n\r\n  const dependencyKey = useMemo(() => {\r\n    if (!dependencies || dependencies.length === 0) return \"static\";\r\n    const values = dependencies.map((dep) => getNestedValue(formValues, dep));\r\n    return JSON.stringify(values);\r\n  }, [dependencies, formValues]);\r\n\r\n  useEffect(() => {\r\n    if (!isAsync) {\r\n      if (Array.isArray(options)) {\r\n        setResolvedOptions(options.map(normalizeOption));\r\n      }\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    if (cacheRef.current.has(dependencyKey)) {\r\n      setResolvedOptions(cacheRef.current.get(dependencyKey)!);\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    let isMounted = true;\r\n\r\n    async function fetchOptions() {\r\n      setIsLoading(true);\r\n\r\n      try {\r\n        const context: ValidationContext = {\r\n          data: formValues,\r\n          siblingData,\r\n          path: path.split(\".\"),\r\n        };\r\n\r\n        const result = await (\r\n          options as (context: ValidationContext) => Promise<SelectOption[]>\r\n        )(context);\r\n\r\n        const normalized = result.map(normalizeOption);\r\n\r\n        if (isMounted) {\r\n          cacheRef.current.set(dependencyKey, normalized);\r\n          setResolvedOptions(normalized);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Failed to fetch select options:\", err);\r\n        if (isMounted) {\r\n          setResolvedOptions([]);\r\n        }\r\n      } finally {\r\n        if (isMounted) {\r\n          setIsLoading(false);\r\n        }\r\n      }\r\n    }\r\n\r\n    fetchOptions();\r\n\r\n    return () => {\r\n      isMounted = false;\r\n    };\r\n  }, [isAsync, options, dependencyKey, formValues, siblingData, path]);\r\n\r\n  return { resolvedOptions, isLoading };\r\n}\r\n\r\nexport function SelectField({\r\n  field,\r\n  path,\r\n  form,\r\n  autoFocus,\r\n  formValues,\r\n  siblingData,\r\n}: SelectFieldProps) {\r\n  const [searchValue, setSearchValue] = useState(\"\");\r\n  const rawValue = form.watch(path);\r\n  const anchorRef = useComboboxAnchor();\r\n\r\n  const error = form.formState.errors[path];\r\n  const errorMessage =\r\n    typeof error === \"string\"\r\n      ? error\r\n      : Array.isArray(error)\r\n        ? error[0]\r\n        : undefined;\r\n  const hasError = !!errorMessage;\r\n\r\n  const isDisabled =\r\n    (typeof field.disabled === \"function\"\r\n      ? field.disabled(formValues, siblingData)\r\n      : (field.disabled ?? false)) || form.formState.isSubmitting;\r\n\r\n  const isReadOnly =\r\n    typeof field.readOnly === \"function\"\r\n      ? field.readOnly(formValues, siblingData)\r\n      : (field.readOnly ?? false);\r\n\r\n  const label = field.label !== false ? (field.label ?? field.name) : null;\r\n  const fieldId = field.id ?? generateFieldId(path);\r\n\r\n  const { resolvedOptions, isLoading } = useAsyncOptions(\r\n    field.options,\r\n    field.dependencies,\r\n    formValues,\r\n    siblingData,\r\n    path\r\n  );\r\n\r\n  const isSearchable = field.ui?.isSearchable !== false;\r\n  const isClearable = field.ui?.isClearable ?? !field.required;\r\n  const maxVisibleChips = field.ui?.maxVisibleChips ?? 3;\r\n  const emptyMessage = field.ui?.emptyMessage ?? \"No results found\";\r\n  const loadingMessage = field.ui?.loadingMessage ?? \"Loading...\";\r\n  const placeholder =\r\n    field.placeholder ??\r\n    (field.hasMany ? \"Select options...\" : \"Select an option...\");\r\n  const searchPlaceholder = \"Search...\";\r\n\r\n  const filteredOptions = useMemo(() => {\r\n    if (!isSearchable || !searchValue.trim()) {\r\n      return resolvedOptions;\r\n    }\r\n    const query = searchValue.toLowerCase();\r\n    return resolvedOptions.filter((opt) =>\r\n      getOptionLabel(opt).toLowerCase().includes(query)\r\n    );\r\n  }, [resolvedOptions, searchValue, isSearchable]);\r\n\r\n  const handleSingleChange = useCallback(\r\n    (stringValue: string | null) => {\r\n      if (stringValue === null) {\r\n        form.setValue(path, undefined, {\r\n          shouldDirty: true,\r\n          shouldValidate: true,\r\n        });\r\n        return;\r\n      }\r\n      const actualValue = stringToValue(stringValue, resolvedOptions);\r\n      form.setValue(path, actualValue, {\r\n        shouldDirty: true,\r\n        shouldValidate: true,\r\n      });\r\n      setSearchValue(\"\");\r\n    },\r\n    [form, path, resolvedOptions]\r\n  );\r\n\r\n  const handleMultiChange = useCallback(\r\n    (stringValues: string[]) => {\r\n      const actualValues = stringValues\r\n        .map((sv) => stringToValue(sv, resolvedOptions))\r\n        .filter((v): v is OptionValue => v !== undefined);\r\n      form.setValue(path, actualValues, {\r\n        shouldDirty: true,\r\n        shouldValidate: true,\r\n      });\r\n    },\r\n    [form, path, resolvedOptions]\r\n  );\r\n\r\n  const singleValue = useMemo(() => {\r\n    if (rawValue === undefined || rawValue === null) return null;\r\n    return valueToString(rawValue as OptionValue);\r\n  }, [rawValue]);\r\n\r\n  const multiValues = useMemo(() => {\r\n    if (!Array.isArray(rawValue)) return [];\r\n    return (rawValue as OptionValue[]).map(valueToString);\r\n  }, [rawValue]);\r\n\r\n  const selectedOption = resolvedOptions.find(\r\n    (o) => singleValue !== null && valueToString(o.value) === singleValue\r\n  );\r\n\r\n  const renderOptionContent = (option: ExtendedSelectOption) => (\r\n    <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n      {option.icon && (\r\n        <span className=\"shrink-0 text-muted-foreground\">{option.icon}</span>\r\n      )}\r\n      <div className=\"flex-1 min-w-0 py-0.5 text-left\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <span className=\"truncate font-medium\">\r\n            {getOptionLabelNode(option)}\r\n          </span>\r\n          {option.badge && (\r\n            <span className=\"shrink-0 px-1.5 py-0.5 rounded-full bg-primary/10 text-primary text-[10px] font-bold uppercase tracking-wider\">\r\n              {option.badge}\r\n            </span>\r\n          )}\r\n        </div>\r\n        {option.description && (\r\n          <div className=\"text-xs text-muted-foreground truncate mt-0.5\">\r\n            {option.description}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  const renderMultiSelect = () => {\r\n    const visibleChips = multiValues.slice(0, maxVisibleChips);\r\n    const hiddenCount = multiValues.length - maxVisibleChips;\r\n\r\n    return (\r\n      <Combobox\r\n        multiple\r\n        value={multiValues}\r\n        onValueChange={handleMultiChange}\r\n        inputValue={searchValue}\r\n        onInputValueChange={setSearchValue}\r\n        disabled={isDisabled || isReadOnly}\r\n      >\r\n        <div ref={anchorRef} className=\"w-full\">\r\n          <ComboboxChips className=\"min-h-8 w-full px-2\">\r\n            {visibleChips.map((val, index) => {\r\n              const opt = resolvedOptions.find(\r\n                (o) => valueToString(o.value) === val\r\n              );\r\n              return (\r\n                <ComboboxChip key={`${val}-${index}`}>\r\n                  {opt ? getOptionLabel(opt) : val}\r\n                </ComboboxChip>\r\n              );\r\n            })}\r\n            {hiddenCount > 0 && (\r\n              <div className=\"bg-muted/50 text-muted-foreground flex h-6 items-center justify-center rounded-sm px-1.5 text-[10px] font-bold whitespace-nowrap\">\r\n                +{hiddenCount}\r\n              </div>\r\n            )}\r\n            {isSearchable && (\r\n              <ComboboxChipsInput\r\n                id={fieldId}\r\n                placeholder={multiValues.length === 0 ? placeholder : \"\"}\r\n                autoFocus={autoFocus}\r\n                className=\"py-1\"\r\n              />\r\n            )}\r\n            {!isSearchable && multiValues.length === 0 && (\r\n              <ComboboxTrigger className=\"flex-1 text-left py-1 text-muted-foreground h-8 px-3\">\r\n                {placeholder}\r\n              </ComboboxTrigger>\r\n            )}\r\n          </ComboboxChips>\r\n        </div>\r\n        <ComboboxContent anchor={anchorRef} className=\"w-(--anchor-width)\">\r\n          <ComboboxList className=\"p-1.5\">\r\n            {isLoading ? (\r\n              <div className=\"py-6 text-center text-sm text-muted-foreground\">\r\n                {loadingMessage}\r\n              </div>\r\n            ) : (\r\n              <>\r\n                {filteredOptions.length === 0 && (\r\n                  <ComboboxEmpty className=\"py-6\">{emptyMessage}</ComboboxEmpty>\r\n                )}\r\n                {filteredOptions.map((option, i) => (\r\n                  <ComboboxItem\r\n                    key={`${valueToString(option.value)}-${i}`}\r\n                    value={valueToString(option.value)}\r\n                    disabled={option.disabled}\r\n                    className=\"py-2 px-2.5\"\r\n                  >\r\n                    {renderOptionContent(option)}\r\n                  </ComboboxItem>\r\n                ))}\r\n              </>\r\n            )}\r\n          </ComboboxList>\r\n        </ComboboxContent>\r\n      </Combobox>\r\n    );\r\n  };\r\n\r\n  const renderSingleSelect = () => (\r\n    <Combobox\r\n      value={singleValue}\r\n      onValueChange={handleSingleChange}\r\n      inputValue={searchValue}\r\n      onInputValueChange={setSearchValue}\r\n      disabled={isDisabled || isReadOnly}\r\n    >\r\n      <div ref={anchorRef} className=\"w-full\">\r\n        <InputGroup className=\"w-full\">\r\n          <InputGroupButton\r\n            id={fieldId}\r\n            render={<ComboboxTrigger />}\r\n            className=\"flex-1 justify-between font-normal h-8 px-3\"\r\n            disabled={isDisabled || isReadOnly}\r\n          >\r\n            {selectedOption ? (\r\n              <span className=\"flex items-center gap-2 truncate text-left\">\r\n                {selectedOption.icon && (\r\n                  <span className=\"shrink-0 text-muted-foreground\">\r\n                    {selectedOption.icon}\r\n                  </span>\r\n                )}\r\n                <span className=\"truncate\">\r\n                  {getOptionLabel(selectedOption)}\r\n                </span>\r\n              </span>\r\n            ) : (\r\n              <ComboboxValue>\r\n                {(value) =>\r\n                  value ?? (\r\n                    <span className=\"text-muted-foreground\">{placeholder}</span>\r\n                  )\r\n                }\r\n              </ComboboxValue>\r\n            )}\r\n          </InputGroupButton>\r\n          {isClearable && singleValue !== null && (\r\n            <InputGroupAddon align=\"inline-end\">\r\n              <ComboboxClear disabled={isDisabled || isReadOnly} />\r\n            </InputGroupAddon>\r\n          )}\r\n        </InputGroup>\r\n      </div>\r\n\r\n      <ComboboxContent anchor={anchorRef} className=\"w-(--anchor-width)\">\r\n        {isSearchable && (\r\n          <div className=\"p-1 border-b\">\r\n            <ComboboxInput\r\n              autoFocus\r\n              placeholder={searchPlaceholder}\r\n              className=\"w-full border-none shadow-none focus-visible:ring-0 h-8\"\r\n              showTrigger={false}\r\n            />\r\n          </div>\r\n        )}\r\n        <ComboboxList className=\"p-1.5\">\r\n          {isLoading ? (\r\n            <div className=\"py-6 text-center text-sm text-muted-foreground\">\r\n              {loadingMessage}\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {filteredOptions.length === 0 && (\r\n                <ComboboxEmpty className=\"py-6\">{emptyMessage}</ComboboxEmpty>\r\n              )}\r\n              {filteredOptions.map((option, i) => (\r\n                <ComboboxItem\r\n                  key={`${valueToString(option.value)}-${i}`}\r\n                  value={valueToString(option.value)}\r\n                  disabled={option.disabled}\r\n                  className=\"py-2 px-2.5\"\r\n                >\r\n                  {renderOptionContent(option)}\r\n                </ComboboxItem>\r\n              ))}\r\n            </>\r\n          )}\r\n        </ComboboxList>\r\n      </ComboboxContent>\r\n    </Combobox>\r\n  );\r\n\r\n  return (\r\n    <Field\r\n      className={field.style?.className}\r\n      data-invalid={hasError}\r\n      data-disabled={isDisabled}\r\n      style={\r\n        field.style?.width\r\n          ? {\r\n              width:\r\n                typeof field.style.width === \"number\"\r\n                  ? `${field.style.width}px`\r\n                  : field.style.width,\r\n            }\r\n          : undefined\r\n      }\r\n    >\r\n      {label && (\r\n        <FieldLabel htmlFor={fieldId} className=\"gap-1 items-baseline\">\r\n          {label}\r\n          {field.required && <span className=\"text-destructive\">*</span>}\r\n        </FieldLabel>\r\n      )}\r\n\r\n      <FieldContent>\r\n        {field.hasMany ? renderMultiSelect() : renderSingleSelect()}\r\n      </FieldContent>\r\n\r\n      {field.description && (\r\n        <FieldDescription id={`${fieldId}-description`}>\r\n          {field.description}\r\n        </FieldDescription>\r\n      )}\r\n\r\n      {errorMessage && <FieldError>{errorMessage}</FieldError>}\r\n    </Field>\r\n  );\r\n}\r\n\r\nexport function SelectFieldSkeleton({ field }: { field: SelectFieldType }) {\r\n  const label = field.label !== false ? (field.label ?? field.name) : null;\r\n\r\n  return (\r\n    <Field\r\n      className={field.style?.className}\r\n      style={\r\n        field.style?.width\r\n          ? {\r\n              width:\r\n                typeof field.style.width === \"number\"\r\n                  ? `${field.style.width}px`\r\n                  : field.style.width,\r\n            }\r\n          : undefined\r\n      }\r\n    >\r\n      {label && <div className=\"h-4 w-24 animate-pulse rounded bg-muted\" />}\r\n      <FieldContent>\r\n        <div className=\"h-8 w-full animate-pulse rounded-lg bg-muted\" />\r\n      </FieldContent>\r\n      {field.description && (\r\n        <div className=\"h-3 w-48 animate-pulse rounded bg-muted\" />\r\n      )}\r\n    </Field>\r\n  );\r\n}\r\n",
      "type": "registry:component",
      "target": "components/buzzform/fields/select.tsx"
    }
  ],
  "type": "registry:ui"
}